{% extends "header.html" %}
{% block content %}
<div class="row">
    {% if folder %}
    <div class="col-lg-3 order-lg-2">
        <div style="font-weight:bold; font-size:20px; word-wrap:break-word">
            {{ folder.name }}
        </div>
        <br>
        <div class="page-item" style="word-wrap: break-word; font-size:14px">
            {% if parent %}
            <div style="font-weight:bold">Parent folder</div>
            <div>
                <a href="{{ url_for('results.folder', folder_id=parent.folder_id) }}" class="tag-link">{{ parent.name }}</a>
            </div>
            {% else %}
            <div>Root folder.</div>
            {% endif %}
            <hr>
            {% if children|length == 0 %}
            <div>No subfolders.</div>
            {% else %}
            <div style="font-weight:bold">Subfolders</div>
            {% for child in children %}
            <div>
                <a href="{{ url_for('results.folder', folder_id=child.folder_id) }}" class="tag-link">{{ child.name }}</a>
            </div>
            {% endfor %}
            {% endif %}
        </div>
        {% if current_user.is_authenticated %}
        <br>
        <div class="page-item" style="word-wrap: break-word; font-size:14px">
            <div>
                <form method="POST" action="" style="margin:0px; width:100%; max-height:100%" class="autocomplete">
                    {{ addtagform.csrf_token }}
                    {{ addtagform.category(hidden="true", value="") }}
                    {{ addtagform.tag(class="addtag-small", autocomplete="off", id="myInput", placeholder="Add tag to all files") }}
                    {{ addtagform.submit(hidden="true") }}
                </form>
            </div>
            <br>
            <div>
                <form method="POST" action="" style="margin:0px">
                    {{ deletetagform.csrf_token }}
                    {{ deletetagform.tag(class="addtag-small", autocomplete="off", placeholder="Delete tag from all files") }}
                    {{ deletetagform.submit(hidden="true") }}
                </form>
            </div>
        </div>
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        {% if category == "success" %}
        <div id="fadeout" class="alert alert-success" style="text-align:center; margin-bottom:0px; margin-top:16px">
            {{ message }}
        </div>
        {% elif category == "warning" %}
        <div id="fadeout" class="alert alert-warning" style="text-align:center; margin-bottom:0px; margin-top:16px">
            {{ message }}
        </div>
        {% endif %}
        {% endfor %}
        {% endif %}
        {% endwith %}
        {% endif %}
        <br>
        <div class="page-item" style="font-size:14px">
            {% if current_user.is_authenticated %}
            <div><b>Notes:</b></div>
            <form method="POST" action="" style="margin:0px; width:100%" class="autocomplete">
                {{ updatedescriptionform.csrf_token }}
                {{ updatedescriptionform.description(class="form-control my-3", style="resize:none; font-size:14px", id="descriptionbox") }}
                {{ updatedescriptionform.submit(class="btn btn-submit float-right") }}
            </form>
            {% else %}
            {% if folder.description %}
            <div><b>Notes:</b></div>
            <pre>{{ folder.description }}</pre>
            {% else %}
            <div>No notes.</div>
            {% endif %}
            {% endif %}
        </div>
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        {% if category == "notes" %}
        <div id="fadeout" class="alert alert-success" style="text-align:center; margin-bottom:0px; margin-top:16px">
            {{ message }}
        </div>
        {% endif %}
        {% endfor %}
        {% endif %}
        {% endwith %}
    </div>
    <div class="col-lg-9 order-lg-1 mt-4 mt-lg-0">
        {% if results|length == 0 %}
        <div align="center">No images</div>
        {% else %}
        <div class="page-item">
            {% for row in results %}
            <div class="row" style="display:flex; align-items: center;">
                {% for item in row %}
                <div class="col-lg-3 col-md-6 col-sm-12 d-flex justify-content-center" style="height:250px; display:flex; align-items: center;">
                    <a href="{{ url_for('results.file', file_id=item.file_id) }}" target="_blank">
                        <img src="{{ 'https://drive.google.com/thumbnail?id=' + item.file_id }}" style="max-width:100%; max-height:100%">
                    </a>
                </div>
                {% endfor %}
            </div>
            {% endfor %}
            <div id="scroller">
                <template id="new_row">
                    <div class="row" style="display:flex; align-items: center;" id="row"></div>
                </template>
            </div>
        </div>
        {% endif %}
    </div>
    {% else %}
    <div class="col" align="center">Folder does not exist.</div>
    {% endif %}
</div>
<div class="d-flex justify-content-center row" id="sentinel">
    <div class="col-9" align="center">
        <div class="spinner-border" style="animation:spinner-border 1s linear infinite; color:rgb(0, 172, 198); margin-top:16px" role="status"></div>
    </div>
    <div class="col-3"></div>
</div>
<script>
    // dynamic loader below
    // extract server response
    var dict = { "ids" : {{ remaining_results|tojson }} };
    var remaining_results = dict.ids;

    var results_url = {{ url_for('results.file', file_id="") }};
    var scroller = document.querySelector("#scroller");
    var template_row = document.querySelector('#new_row');
    var loaded = document.querySelector("#loaded");
    var sentinel = document.querySelector('#sentinel');

    // disable sentinel if unnecessary
    if (remaining_results.length <= 10) {
        sentinel.innerHTML = "";
    }

    // loads more images
    function loadItems() {
        if (remaining_results.length > 0) {
            new_section = [];
            if (remaining_results.length < 10) {
                new_section = remaining_results.slice(0,remaining_results.length);
                remaining_results = [];
            } else {
                new_section = remaining_results.slice(0, 10);
                remaining_results = remaining_results.slice(10,remaining_results.length);
            }
            
            new_section.forEach(function(new_row) {
                let template_clone = template_row.content.cloneNode(true);
                var innerhtml = "";
                new_row.forEach(function(file_id) {
                    var href = results_url + file_id;
                    var src = 'https://drive.google.com/thumbnail?id=' + file_id;
                    innerhtml += `  <div class="col-lg-3 col-md-6 col-sm-12 d-flex justify-content-center" style="height:250px; display:flex; align-items: center;">
                                        <a href="` + href + `" id="link" target="_blank">
                                            <img src="` + src + `" style="max-width:100%; max-height:100%" id="image">
                                        </a>
                                    </div>`
                })
                template_clone.querySelector("#row").innerHTML = innerhtml;
                scroller.appendChild(template_clone);
            })
        } else {
            sentinel.innerHTML = "";
        }
    }

    // time used to prevent function being called more than once at the same time
    var time = Date.now()

    // detects if end of page is reached
    var intersectionObserver = new IntersectionObserver(entries => {
        if (entries[0].intersectionRatio <= 0 || Date.now() - time < 10) {
            return;
        }
        loadItems();
        time = Date.now()
    });

    intersectionObserver.observe(sentinel);

    {% if current_user.is_authenticated %}
    // tag autocomplete below
    function autocomplete(inp, arr) {
        var currentFocus;

        // checks for new input
        inp.addEventListener("input", function(e) {
            var a, b, i, val = this.value;
            closeAllLists();
            if (!val) { return false;}
            currentFocus = -1;
            
            // div element containing tags
            a = document.createElement("DIV");
            a.setAttribute("id", this.id + "autocomplete-list");
            a.setAttribute("class", "autocomplete-items");
            this.parentNode.appendChild(a);
            
            var numItems = 0;
            for (i = 0; i < arr.length; i++) {
                // check for same initial letters ignoring case and limits results to 5
                if (arr[i].substr(0, val.length).toUpperCase() == val.toUpperCase() && numItems++ < 5) {
                    b = document.createElement("DIV");
                    b.innerHTML = "<strong>" + arr[i].substr(0, val.length) + "</strong>";
                    b.innerHTML += arr[i].substr(val.length);
                    b.innerHTML += "<input type='hidden' value='" + arr[i] + "'>";
                    b.setAttribute("style", "padding:3px")

                    // called when tag is clicked
                    b.addEventListener("click", function(e) {
                        inp.value = this.getElementsByTagName("input")[0].value;
                        closeAllLists();
                    });
                a.appendChild(b);
                }
            }

            // selects first item
            if (numItems > 0) {
                var x = document.getElementById(this.id + "autocomplete-list");
                if (x) x = x.getElementsByTagName("div");
                currentFocus++;
                addActive(x);
            }
        });

        // checks when key is pressed
        inp.addEventListener("keydown", function(e) {
            var x = document.getElementById(this.id + "autocomplete-list");
            if (x) x = x.getElementsByTagName("div");
            if (e.keyCode == 40) { // down
                currentFocus++;
                addActive(x);
            } else if (e.keyCode == 38) { // up
                currentFocus--;
                addActive(x);
            } else if (e.keyCode == 13 && document.getElementsByClassName("autocomplete-active").length != 0) { // enter
                e.preventDefault();
                if (currentFocus > -1) {
                    if (x) x[currentFocus].click();
                }
            }
        });

        // select tag
        function addActive(x) {
            if (!x) return false;
            removeActive(x);
            if (currentFocus >= x.length) currentFocus = 0;
            if (currentFocus < 0) currentFocus = (x.length - 1);
            x[currentFocus].classList.add("autocomplete-active");
        }

        // deselect tag
        function removeActive(x) {
            for (var i = 0; i < x.length; i++) {
                x[i].classList.remove("autocomplete-active");
            }
        }

        // close tag list
        function closeAllLists(elmnt) {
            var x = document.getElementsByClassName("autocomplete-items");
            for (var i = 0; i < x.length; i++) {
                if (elmnt != x[i] && elmnt != inp) {
                    x[i].parentNode.removeChild(x[i]);
                }
            }
        }

        document.addEventListener("click", function (e) {
            closeAllLists(e.target);
        });
    }

    // extract server response
    var dict = { "tags" : {{ tags|tojson }} };
    var tags = dict.tags;

    autocomplete(document.getElementById("myInput"), tags);
    {% endif %}

    // resize description box below
    var descriptionbox = document.getElementById("descriptionbox");
    function resizeDescriptionBox() {
        descriptionbox.style.height = "";
        descriptionbox.style.height = Math.max(descriptionbox.scrollHeight, 55) + 2 + "px";
    }
    resizeDescriptionBox(); // onload call
    descriptionbox.oninput = resizeDescriptionBox;
</script>
{% endblock %}